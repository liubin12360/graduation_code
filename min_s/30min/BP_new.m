clear 
clc
warning off 
nntwarn off

global p     % Training input of data
global t     % Training output of data
global R     % The number of input node
global S2    % The number of output node
global S1    % The number of hidden layers node
global S     % Encoding length
S1=7;
allerror = 0;


day=[
12.7	88	23	0.99
13.3	89	32	1.38
14.4	87	36	1.55
15.7	84	87	3.74
17.1	80	196	8.43
17.6	77	211	9.07
18	74	233	10.02
18.7	72	278	11.96
19.2	71	332	14.28
19.7	66	322	13.85
18.3	79	171	7.35
18.1	84	243	10.45
18.7	85	240	10.32
18.4	85	138	5.93
17.4	90	93	4
17.9	90	173	7.44
18.4	85	145	6.24
18.4	85	75	3.23
18.5	85	70	3.01
18.3	88	87	3.74
18	90	48	2.06
17.8	92	45	1.94
13.7	94	36	1.55
13.8	94	78	3.35
14.1	93	89	3.83
14.6	92	143	6.15
15.4	89	91	3.91
16.1	83	149	6.41
16.8	81	216	9.29
17.5	77	244	10.49
17.9	75	248	10.67
18.6	74	232	9.98
18.5	72	284	12.21
18.8	72	243	10.45
19.2	71	209	8.99
19.6	70	256	11.01
20.7	67	392	16.86
21.4	64	355	15.27
21.3	65	252	10.84
21	68	237	10.19
22	64	287	12.34
21.3	67	126	5.42
20.5	71	111	4.77
19.8	76	88	3.78
14.9	95	34	1.46
15.6	95	47	2.02
16.4	95	79	3.4
17.2	94	78	3.35
17.9	89	105	4.52
18.8	84	136	5.85
19.2	81	179	7.7
19.8	79	250	10.75
20.4	77	294	12.64
21.1	73	395	16.99
22.5	68	640	27.52
22.2	68	403	17.33
21.5	69	227	9.76
22.1	67	395	16.99
23.9	57	665	28.6
24.4	54	625	26.88
24.6	53	581	24.99
24.6	49	521	22.41
24.7	48	454	19.52
23.7	50	344	14.79
23.4	49	309	13.29
21.9	54	117	5.03
16.3	91	47	2.02
16.6	90	61	2.62
17	90	69	2.97
17.6	88	91	3.91
18.3	84	128	5.5
19.1	81	179	7.7
19.3	78	163	7.01
19.9	77	232	9.98
20.2	76	233	10.02
20.4	73	272	11.7
21.1	70	346	14.88
21	70	240	10.32
20.8	71	185	7.96
21.1	69	198	8.52
21	65	226	9.72
21.4	66	178	7.65
21.5	67	186	8
20.6	73	130	5.59
20.2	74	102	4.39
19.9	73	82	3.53
19.7	73	78	3.35
20.1	72	119	5.12
15.4	90	10	0.43
15.5	90	20	0.86
15.7	89	39	1.68
15.7	89	59	2.54
15.9	89	75	3.23
16.1	89	70	3.01
16.2	88	70	3.01
16.3	87	86	3.7
16.6	86	135	5.81
17.1	85	166	7.14
17.3	83	193	8.3
17.7	82	188	8.09
18.1	81	187	8.04
18.5	81	222	9.55
19	77	279	12
19.6	75	272	11.7
19.9	73	311	13.37
19.8	73	247	10.62
19.6	73	158	6.79
19.4	73	156	6.71
19.1	73	80	3.44
19.2	73	48	2.06
15.1	87	22	0.95
15.2	88	36	1.55
15.3	88	37	1.59
15.8	86	63	2.71
16.3	86	78	3.35
17.1	81	145	6.24
17.6	80	162	6.97
18.2	77	208	8.95
19.1	74	263	11.31
19.3	75	317	13.63
19.5	72	350	15.05
19.4	73	164	7.05
19.5	71	230	9.89
19.7	74	172	7.4
19.7	74	122	5.25
19.7	73	70	3.01
19.6	74	107	4.6
19.3	78	46	1.98
19.1	78	58	2.49
19.1	78	131	5.63
19.8	75	163	7.01
19.7	76	79	3.4
14.2	94	40	1.72
14.1	95	65	2.8
14.5	95	93	4
15.1	93	170	7.31
15.3	92	130	5.59
15.6	92	155	6.67
16.2	89	216	9.29
16.1	89	105	4.52
16.4	89	111	4.77
16.3	88	94	4.04
17	82	246	10.58
17.6	76	307	13.2
18.9	70	444	19.09
19.4	65	594	25.55
21	59	609	26.19
21.1	59	490	21.07
21.4	55	532	22.88
21.7	54	428	18.41
21.7	54	334	14.36
21.9	54	252	10.84
21.6	53	257	11.05
19.9	58	71	3.05
9.8	87	24	1.03
10.5	88	31	1.33
11.4	88	36	1.55
12.9	88	43	1.85
13.8	85	56	2.41
14.8	79	68	2.92
16.1	69	127	5.46
16.8	64	88	3.78
17.7	60	166	7.14
19	56	545	23.44
19.6	53	649	27.91
21.3	45	669	28.77
21.2	46	676	29.07
22.7	42	676	29.07
20.9	52	716	30.79
20.8	50	620	26.66
21.1	49	552	23.74
21.1	48	515	22.15
19.4	53	407	17.5
20.1	53	308	13.25
19.4	55	267	11.48
19.1	57	132	5.68
12.4	86	40	1.72
13.1	85	59	2.54
13.7	83	45	1.94
14.3	80	46	1.98
15.1	75	50	2.15
15.7	73	70	3.01
16.6	70	231	9.93
17.3	66	133	5.72
18.3	62	191	8.21
19.2	59	505	21.72
19.7	55	498	21.42
21.1	52	675	29.03
20.9	52	246	10.58
21.3	50	553	23.78
20.5	53	152	6.54
20.2	57	422	18.15
20	58	118	5.07
20.4	58	324	13.93
19.3	61	171	7.35
19.3	62	204	8.77
20	60	281	12.08
18.4	63	81	3.48
11.6	88	26	1.12
12.1	89	36	1.55
12.9	88	45	1.94
13.9	86	50	2.15
14.9	82	66	2.84
15.9	79	142	6.11
17.3	71	316	13.59
17.9	64	236	10.15
19.1	58	264	11.35
19.1	56	242	10.41
19.3	54	334	14.36
19.6	55	218	9.38
21.6	52	638	27.44
20.1	57	330	14.19
19.6	59	234	10.06
20	58	287	12.34
19.4	61	197	8.47
18.6	64	124	5.33
18.2	66	101	4.34
18.2	66	140	6.02
19.2	63	183	7.87
18.2	64	80	3.44
13.9	80	11	0.47
14	79	22	0.95
14.2	79	39	1.68
14.6	78	60	2.58
14.8	77	94	4.04
15.4	76	132	5.68
15.8	75	153	6.58
16.4	73	185	7.96
17.1	71	241	10.36
17.5	69	268	11.53
17.7	68	206	8.86
17.4	68	186	8
17.2	70	165	7.1
17.7	69	196	8.43
18.8	64	366	15.74
18.8	63	254	10.92
18.8	64	181	7.78
18.8	65	148	6.36
18.6	65	111	4.77
18.1	67	79	3.4
17.9	67	71	3.05
17.9	69	82	3.53
];

p=day(1:220,1:3)';
t=1*day(1:220,4)';

[pn,ps]=mapminmax(p);
[tn,ts]=mapminmax(t);

input_test=day(221:242,1:3)';
output_test=1*day(221:242,4)';

inputn_test=mapminmax('apply',input_test,ps);


net=newff(minmax(pn),[S1,1],{'tansig','purelin'},'trainlm'); 

net.trainParam.show=25;  %ÏÔÊ¾µÄ¼ä¸ô´ÎÊý
net.trainParam.epochs=10000;
%net.trainParam.goal=0.0000001;
%net.trainParam.lr=0.01;

net.trainParam.goal=0.00001;
net.trainParam.lr=0.01;

%net.performFcn = 'mse';
%disp(mse);
%net.trainParam.mc=0.4;  %¶¯Á¿Òò×ÓµÄÉèÖÃ£¬Ä¬ÈÏÎª0.9

[net,tr]=train(net,pn,tn);

s_bp=sim(net,inputn_test);    

BPoutput=mapminmax('reverse',s_bp,ts)
output_test

%disp(abs(BPoutput-output_test));
%disp(BPoutput-output_test);
%disp(power(BPoutput-output_test,2));

figure(1)
plot(BPoutput,':or');
hold on
plot(output_test,'-*');
legend('forecasting','actural')
title('BPNNresult','fontsize',12)
ylabel('power_output','fontsize',12)
xlabel('test time','fontsize',12)
%set(gcf,'color','white');
%set(gca,'color','none');
set(gca,'XTick',[1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22])
set(gca,'XTickLabel',{'7:30','8:00','8:30','9:00','9:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'})
grid
hold off

%%BP(Estimate the absolute value error)
error=abs(BPoutput-output_test)
%allerror = allerror + error;
%disp(allerror);
figure(2)
plot(error,'-*')
legend('forecasting error')
title('BPNNforecasting error','fontsize',12)
ylabel('error','fontsize',12)
xlabel('test time','fontsize',12)
%set(gcf,'color','white');
%set(gca,'color','none');
set(gca,'XTick',[1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22])
set(gca,'XTickLabel',{'7:30','8:00','8:30','9:00','9:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'})
grid
hold off

figure(3)
plot((error./output_test)*100,'-*');
%disp((error./output_test)*100);
error_rate = (error./output_test)*100
MAPE = mean(error_rate)
title('BPNN error rate ')
ylabel('Error rate','fontsize',12)
xlabel('test time','fontsize',12)
set(gcf,'color','white'); 
set(gca,'color','none');
set(gca,'XTick',[1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22])
set(gca,'XTickLabel',{'7:30','8:00','8:30','9:00','9:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'})
grid
hold off

figure(4)
plot(1-(error./output_test)*100,'-*');
title('BPNN prediction accuracy')
ylabel('Prediction accuracy','fontsize',12)
xlabel('Sample','fontsize',12)
set(gcf,'color','white'); 
grid
hold off